<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>back/modules/appRequests.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Stratego.html">Stratego</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stratego.html#addPlayer">addPlayer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stratego.html#endGame">endGame</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stratego.html#saveGame">saveGame</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="AppRequest.html">AppRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.connectAccount">connectAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.deleteAccount">deleteAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.registerAccount">registerAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.sendHome">sendHome</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.sendProfile">sendProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.sendRules">sendRules</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.sendScores">sendScores</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Database.html">Database</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#.delete">delete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#.find">find</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#.login">login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#.register">register</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Request.html">Request</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Request.html#.sendDelete">sendDelete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Request.html#.sendLogin">sendLogin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Request.html#.sendRegister">sendRegister</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="scores.html">scores</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="scores.html#.getRankData">getRankData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="scores.html#.getRankInfos">getRankInfos</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="scores.html#.getRankLine">getRankLine</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="storage.html">storage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="storage.html#.editData">editData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="storage.html#.getData">getData</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="tabledraw.html">tabledraw</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="tabledraw.html#.draw">draw</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Toast.html">Toast</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Toast.html#.error">error</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#io">io</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#port">port</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#server">server</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">back/modules/appRequests.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Process the POST and GET requests from the express app in index.js
 * @version 1.0
 * @author Stratego Online
 */

//Requires
const fs = require("fs");
const { body, validationResult, query } = require("express-validator");
const sha256 = require("js-sha256").sha256;
const db = require("./query").database;
const toast = require("./toasts");

/**
 * Process the POST and GET requests from the express app in index.js
 * @type {Object}
 * @return {Object} functions to use with the AppRequest module
 * @name AppRequest
 * @namespace AppRequest
 */
let AppRequest = (function () {
  /**
   * @function AppRequest.sendHome
   * @param {Object} request
   * user's request
   * @param {Object} response
   * server's response
   * @returns {} /
   * @description GET request handler for the site's main page
   */
  let sendHomeCall = (req, res) => {
    let fileSend = fs.readFileSync("front/html/head.html");
    // Check if the player is connected to change the navbar or not
    //console.log(req.session.username); //DEBUG
    if (!req.session.username)
      fileSend += fs.readFileSync("front/html/login.html");
    else {
      fileSend += fs.readFileSync("front/html/logged.html");
      fileSend +=
        '&lt;script>document.getElementById("connectButton").innerText = "' +
        req.session.username +
        '";document.getElementById("connectModalLabel").innerText="' +
        req.session.username +
        '";&lt;/script>';
    }
    fileSend += fs.readFileSync("front/html/index.html");
    fileSend += fs.readFileSync("front/html/footer.html");
    res.send(fileSend);
  };

  //===============================================================================
  /**
   * @function AppRequest.sendScores
   * @param {Object} request
   * @param {Object} response
   * @returns {} /
   * @description GET request handler for the site's scores page
   */
  let sendScoresCall = (req, res) => {
    let fileSend = fs.readFileSync("front/html/head.html");
    // Check if the player is connected to change the navbar or not
    //console.log(req.session.username); // DEBUG
    if (!req.session.username)
      fileSend += fs.readFileSync("front/html/login.html");
    else {
      fileSend += fs.readFileSync("front/html/logged.html");
      fileSend +=
        '&lt;script>document.getElementById("connectButton").innerText = "' +
        req.session.username +
        '";document.getElementById("connectModalLabel").innerText="' +
        req.session.username +
        '";&lt;/script>';
    }
    fileSend += `&lt;script>document.getElementById("homeLink").classList.remove("active");document.getElementById("scoresLink").classList.add("active");&lt;/script>`;
    fileSend += fs.readFileSync("front/html/scores.html");
    //TODO update scores ?
    fileSend += fs.readFileSync("front/html/footer.html");
    res.send(fileSend);
  };

  //===============================================================================
  /**
   * @function AppRequest.sendProfile
   * @param {Object} request
   * @param {Object} response
   * @returns {} /
   * @description GET request handler for an user's profile page
  */
  let sendProfileCall = (req, res) => {
    let fileSend = fs.readFileSync("front/html/head.html");
    if (!req.session.username) {
      //Redirect to the home page + error message
      //Error message
      //TODO FIX message not displayed => add an arg to the session ? like an error code ?
      //fileSend += toast.error("Please login before accessing your profile...");
      res.redirect("/");
    } else {
      //Load the profile
      fileSend += fs.readFileSync("front/html/logged.html");
      fileSend +=
        '&lt;script>document.getElementById("connectButton").innerText = "' +
        req.session.username +
        '";document.getElementById("connectModalLabel").innerText="' +
        req.session.username +
        '";&lt;/script>';
      fileSend += `&lt;script>document.getElementById("homeLink").classList.remove("active");&lt;/script>`;

      fileSend += fs.readFileSync("front/html/profile.html");
      //Fill the table with session values
      fileSend += `&lt;script>document.getElementById("usernameToInsert").innerText = "${req.session.username}";`;
      fileSend += `document.getElementById("emailToInsert").innerText = "${req.session.login}";&lt;/script>`;

      fileSend += fs.readFileSync("front/html/footer.html");
      res.send(fileSend);
    }
  };

  //===============================================================================
  /**
   * @function AppRequest.sendRules
   * @param {Object} request
   * @param {Object} response
   * @returns {} /
   * @description GET request handler for the site's rules page
   */
  let sendRulesCall = (req, res) => {
    let fileSend = fs.readFileSync("front/html/head.html");
    // Check if the player is connected to change the navbar or not
    //console.log(req.session.username); //DEBUG
    if (!req.session.username)
      fileSend += fs.readFileSync("front/html/login.html");
    else {
      fileSend += fs.readFileSync("front/html/logged.html");
      fileSend +=
        '&lt;script>document.getElementById("connectButton").innerText = "' +
        req.session.username +
        '";document.getElementById("connectModalLabel").innerText="' +
        req.session.username +
        '";&lt;/script>';
    }
    fileSend += `&lt;script>document.getElementById("homeLink").classList.remove("active");document.getElementById("rulesLink").classList.add("active");&lt;/script>`;
    fileSend += fs.readFileSync("front/html/rules.html");
    fileSend += fs.readFileSync("front/html/footer.html");
    res.send(fileSend);
  };

  //===============================================================================
  /**
   * @function AppRequest.connectAccount
   * @param {Object} request
   * @param {Object} response
   * @returns {} /
   * @description POST request handler for an user connection to his account
   */
  let connectAccountCall = (req, res) => {
    const errors = validationResult(req);

    if (
      !errors.isEmpty() ||
      req.body.email === undefined ||
      req.body.password === undefined
    ) {
      console.log(errors);
      return res.status(400).json({ errors: errors.array() });
    } else {
      let emailChecked = escape(req.body.email.trim());
      let passwordChecked = req.body.password;

      // Check if the credentials are correct
      if (
        emailChecked.length > 3 &amp;&amp;
        /[@]/.test(emailChecked) &amp;&amp;
        passwordChecked.length > 8 &amp;&amp;
        /\d/.test(passwordChecked) &amp;&amp;
        /[A-Z]/.test(passwordChecked) &amp;&amp;
        /[a-z]/.test(passwordChecked)
      ) {
        // Check if the user exists and output his username
        db.login(emailChecked, sha256(passwordChecked), (result) => {
          if (result !== undefined) {
            //Connection successful
            req.session.username = result.username;
            req.session.login = result.login;
          } else {
            //Connection unsuccessful
            //TODO Display an error message to the user
            console.log("User not found in the db...");
          }

          req.session.save();
          res.redirect(req.get("referer")); //Redirects to the current page
        });
      } else {
        //TODO Display an error message to the user
        console.log("Wrong logins credentials...");
        res.redirect(req.get("referer")); //Redirects to the current page
      }
    }
  };

  //===============================================================================
  /**
   * @function AppRequest.registerAccount
   * @param {Object} request
   * @param {Object} response
   * @returns {} /
   * @description POST request handler for an user registration to the site
   */
  let registerAccountCall = (req, res) => {
    const errors = validationResult(req);

    if (!errors.isEmpty()) {
      console.log(errors);
      return res.status(400).json({ errors: errors.array() });
    } else {
      //Get XMLHttpRequests values
      let emailChecked = escape(req.body.email.trim());
      let passwordChecked = req.body.password;
      let password2Checked = req.body.password2;
      let usernameChecked = escape(req.body.username.trim());

      console.log(
        emailChecked,
        passwordChecked,
        password2Checked,
        usernameChecked
      );

      // Check if the credentials are correct
      if (
        usernameChecked.length > 3 &amp;&amp;
        emailChecked.length > 3 &amp;&amp;
        /[@]/.test(emailChecked) &amp;&amp;
        passwordChecked === password2Checked &amp;&amp;
        passwordChecked.length > 8 &amp;&amp;
        /\d/.test(passwordChecked) &amp;&amp;
        /[A-Z]/.test(passwordChecked) &amp;&amp;
        /[a-z]/.test(passwordChecked)
      ) {
        db.find(emailChecked, (username) => {
          if (username === undefined) {
            //Connection successful and the user doesn't already exist
            db.register(
              emailChecked,
              sha256(passwordChecked),
              usernameChecked,
              (affectedRows) => {
                if (affectedRows === 1) {
                  //User addition successful -> fill the session values
                  req.session.username = usernameChecked;
                  req.session.login = emailChecked;
                } else {
                  //User addition unsuccessful
                  console.log("Error while adding an user to the DB...");
                }

                req.session.save();
                res.redirect("/");
              }
            );
          } else {
            //User can't be registered because his email is already in use
            //TODO Display an error message to the user
            console.log("Email already in use...");
            res.redirect("/register/");
          }
        });
      } else {
        //TODO Display an error message to the user
        console.log("Wrong logins credentials...");
        res.redirect("/register/");
      }
    }
  };

  //===============================================================================
  /**
   * @function AppRequest.deleteAccount
   * @param {Object} request
   * @param {Object} response
   * @returns {} /
   * @description POST request handler for an user's account deletion
   */
  let deleteAccountCall = (req, res) => {
    const errors = validationResult(req);

    if (
      !errors.isEmpty() ||
      req.body.login === undefined ||
      req.body.username === undefined
    ) {
      console.log(errors);
      return res.status(400).json({ errors: errors.array() });
    } else {
      //Get XMLHttpRequests values
      if (
        escape(req.body.login.trim()) == req.session.login &amp;&amp;
        escape(req.body.username.trim()) == req.session.username
      ) {
        //If the XHR values are correct => preform the query
        db.delete(req.session.login, req.session.username, (affectedRows) => {
          if (affectedRows === 1) {
            //TODO Display a deletion successful message
          } else {
            //User addition unsuccessful
            //TODO Display an error message to the user
            console.log("Error while deleting an user to the DB...");
          }

          req.session.destroy();
          res.redirect("/");
        });
      } else {
        //TODO Display an error message to the user
        console.log("Error while sending the request to the server...");
      }
    }
  };

  //Object to return
  return {
    sendHome: (req, res) => sendHomeCall(req, res),
    connectAccount: (req, res) => connectAccountCall(req, res),
    registerAccount: (req, res) => registerAccountCall(req, res),
    deleteAccount: (req, res) => deleteAccountCall(req, res),
    sendScores: (req, res) => sendScoresCall(req, res),
    sendProfile: (req, res) => sendProfileCall(req, res),
    sendRules: (req, res) => sendRulesCall(req, res),
  };
})();

module.exports = AppRequest;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Tue Mar 02 2021 00:50:40 GMT+0100 (Central European Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
