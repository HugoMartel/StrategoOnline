<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Game.html">Game</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Pieces.html">Pieces</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Table.html">Table</a></span></li><li class="nav-heading">Namespaces</li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="AppRequest.html">AppRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.connectAccount">connectAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.deleteAccount">deleteAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.registerAccount">registerAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.sendHome">sendHome</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.sendProfile">sendProfile</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.sendRules">sendRules</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="AppRequest.html#.sendScores">sendScores</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Canvas.html">Canvas</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Canvas.html#.drawCanvas">drawCanvas</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Canvas.html#.getCursorPosition">getCursorPosition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Canvas.html#.resizeCanvas">resizeCanvas</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Canvas.html#.startMenuSetup">startMenuSetup</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="ClientRequest.html">ClientRequest</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ClientRequest.html#.sendDelete">sendDelete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ClientRequest.html#.sendLogin">sendLogin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ClientRequest.html#.sendRegister">sendRegister</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ClientRequest.html#.sendXHR">sendXHR</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Database.html">Database</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#.delete">delete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#.find">find</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#.login">login</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Database.html#.register">register</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Graphics.html">Graphics</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Graphics.html#.createScene">createScene</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Graphics.html#.deplace">deplace</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Scenes.html">Scenes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Scenes.html#.clear">clear</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Scenes.html#.gameBoard">gameBoard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Scenes.html#.setupBabylon">setupBabylon</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Scenes.html#.startMenu">startMenu</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Scenes.html#.waitingMenu">waitingMenu</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Scores.html">Scores</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Scores.html#.getRankData">getRankData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Scores.html#.getRankInfos">getRankInfos</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Scores.html#.getRankLine">getRankLine</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Socket.html">Socket</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Socket.html#.matchCreated">matchCreated</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Socket.html#.matchReady">matchReady</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Storage.html">Storage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Storage.html#.editData">editData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Storage.html#.getData">getData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Storage.html#.saveJSONData">saveJSONData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Storage.html#.storeLeaderboard">storeLeaderboard</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Stratego.html">Stratego</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stratego.html#.endGame">endGame</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Stratego.html#.saveGame">saveGame</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="TableDraw.html">TableDraw</a></span></li><li class="nav-heading"><span class="nav-item-type type-namespace">N</span><span class="nav-item-name"><a href="Toast.html">Toast</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Toast.html#.error">error</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Toast.html#.error">error</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Toast.html#.success">success</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#io">io</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#port">port</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#server">server</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Main page of the project, start the webserver by executing it
 * @author Stratego Online
 * @version 1.0
 */

//****************************
//*         Consts           *
//****************************
// Setup requires and https keys &amp; certificates
const express = require("express");
const app = express();
const fs = require("fs");
const https = require("https");
const AppRequest = require("./back/modules/appRequests");
const { Game, Stratego } = require("./back/classes/stratego");
const Storage = require("./back/modules/storage");

// Just for the readability of the console logs on the server side
const colors = require("colors");

const hsKey = fs.readFileSync(__dirname + "/ssl/key.pem").toString();
const hsCert = fs.readFileSync(__dirname + "/ssl/cert.pem").toString();

// Request handling requires
const sharedsession = require("express-socket.io-session");
const bodyParser = require("body-parser");
const jsonParser = bodyParser.json();
const urlencodedParser = bodyParser.urlencoded({ extended: false });

// Setup server and socket
/** @constant {Object} server https server used to host the project*/
const server = https.createServer({ key: hsKey, cert: hsCert }, app);
/** @constant {Object} io socket module used to identify clients*/
const io = require("socket.io")(server, { secure: true });
/** @constant {number} port port used to host the server on*/
const port = 4200;

//****************************
//*         Session          *
//****************************
const session = require("express-session")({
  //! DON'T FORGET TO CHANGE THE SECRET -> sha256(secretSECRET)
  secret: "ed4d86e9808c052ce883c8ef98da9786eb8b608a798cffb2814cdf21a20026b8",
  resave: true,
  saveUninitialized: true,
  cookie: {
    maxAge: 2 * 60 * 60 * 1000,
    secure: true,
  },
});

//****************************
//*      Configuration       *
//****************************
// App params
app.set("trust proxy", 1);

// Configure socket io with session middleware
io.use(
  sharedsession(session, {
    // Save session if it is changed
    autoSave: true,
  })
);

// Router
app.use(express.static(__dirname + "/front/"));
app.use(jsonParser);
app.use(urlencodedParser);
app.use(session);

//****************************
//*        Requests          *
//****************************
// GET
app.get("/", AppRequest.sendHome);
app.get("/register/", (req, res) => {
  let fileSend = fs.readFileSync("front/html/head.html");
  fileSend += `&lt;script>document.getElementById("homeLink").classList.remove("active");&lt;/script>`;
  fileSend += fs.readFileSync("front/html/register.html");
  res.send(fileSend);
});
app.get("/disconnect/", (req, res) => {
  // Destroy the session and reload
  req.session.destroy();
  res.redirect("/");
});
app.get("/leaderboard/", AppRequest.sendScores);
app.get("/profile/", AppRequest.sendProfile);
app.get("/rules/", AppRequest.sendRules);

// POST
app.post("/", jsonParser, AppRequest.connectAccount);
app.post("/register/", jsonParser, AppRequest.registerAccount);
app.post("/profile/", jsonParser, AppRequest.deleteAccount);

//****************************
//*        Socket.io         *
//****************************
let gameWaiting = false;

io.on("connection", (client) => {
  // Console message on connection
  console.log("> ".bold + client.id.green + " connected");

  // Console message on disconnection
  client.on("disconnect", () => {
    // END or DELETE games where the client could be a part of

    console.log("&lt; ".bold + client.id.red + " disconnected");
  });

  client.on("disconnecting", (reason) => {
    for (const room of client.rooms) {
      if (room !== client.id) {
        // Disconnecting during a game
        //TODO
        client.to(room).emit("user left", client.id);
      }
    }
  });

  //===================================================================
  /******************************\
    An user wants to find a game
  \******************************/
  client.on("newGame", () => {
    let clientSocket = io.sockets.sockets.get(client.id); // correct way to access a map object in js
    //console.log(clientSocket); //DEBUG

    /* There are no user waiting for a game */
    if (gameWaiting === false) {
      // TimeStamp to use for identification
      let currentTime = Date.now().toString();

      //Store the user in a new game object
      let newGame = new Game(
        clientSocket.handshake.session.login !== undefined
          ? clientSocket.handshake.session.login
          : clientSocket.id,
        currentTime
      );

      //Make the client join a socket room
      client.join(currentTime);

      // Send things to display to the client
      io.sockets.to(newGame.room_name).emit("match created", {
        username1: newGame.player1
      });

      //Save the game as a JSON file in ./back/storage/games/waiting
      //idea to name files : fs.readdirSync(__dirname + "/back/storage/games/waiting").length // Counts the amount of files in the directory
      Stratego.saveGame("games/waiting/" + currentTime, newGame);

      gameWaiting = true;
      console.log("A new game has been created".underline);
    } else {
      /* A game is already waiting for a second player */

      //Removes the .json and converts to int to ease comparison
      let waitingGamesNames = fs
        .readdirSync(__dirname + "/back/storage/games/waiting")
        .map((value, index, array) =>
          parseInt(value.slice(0, value.length - 5))
        );

      // Game to add our user into
      //Find the game that is waiting for the longest time (= has the lowest timestamp)
      let waitingGameTimeStamp = Math.min.apply(null, waitingGamesNames);
      let waitingGame = Storage.getData(
        "games/waiting/" + waitingGameTimeStamp
      );

      //add the user the the correct socket room
      client.join(waitingGameTimeStamp.toString());

      waitingGame.player2 =
        clientSocket.handshake.session.login !== undefined
          ? clientSocket.handshake.session.login
          : client.id;

      //Save the game as a JSON file in ./back/storage/games
      Stratego.saveGame(
        "games/" + waitingGame.player1 + "+" + waitingGame.player2,
        waitingGame
      );

      console.log(client.rooms);

      //Remove the waiting JSON game file from ./back/storage/games/waiting
      fs.unlink(
        __dirname +
          "/back/storage/games/waiting/" +
          waitingGameTimeStamp +
          ".json",
        (err) => {
          if (err) throw err;
        }
      );

      gameWaiting = false;
      console.log("A game is starting".underline);

      //Update the first user's interface with the second player's name
      io.sockets.to(waitingGame.room_name).emit("match ready", {
        username1: waitingGame.player1,
        username2: waitingGame.player2,
      });
    }
  });
});

//****************************
//*       Server Start       *
//****************************
// Make the server use port 4200
server.listen(4200, () => {
  console.log("Server is up and running on https://localhost:" + port + "/");
});

//****************************
//*     Clean up on exit     *
//****************************
process.stdin.resume(); //so the program will not close instantly

function exitHandler(options, exitCode) {
  if (options.cleanup) {
    console.log(
      "\n------------------------------------------------------------------"
    );
    console.log("Cleaning up the files...");

    // Remove waiting game files
    fs.readdirSync(__dirname + "/back/storage/games/waiting").forEach(
      (filename) => {
        if (filename != "9999999999999999.json") {
          fs.unlinkSync(
            __dirname + "/back/storage/games/waiting/" + filename,
            (err) => {
              if (err) throw err;
            }
          );
          console.log(
            "/back/storage/games/waiting/" + filename + " was " + "deleted".bold
          );
        }
      }
    );

    // Remove filled game files
    fs.readdirSync(__dirname + "/back/storage/games").forEach((filename) => {
      if (filename != "TEMPLATE.json" &amp;&amp; filename != "waiting") {
        fs.unlinkSync(__dirname + "/back/storage/games/" + filename, (err) => {
          if (err) throw err;
        });
        console.log(
          "/back/storage/games/" + filename + " was " + "deleted".bold
        );
      }
    });
  }
  if (exitCode || exitCode === 0) console.log(exitCode);
  if (options.exit) process.exit();
}

//do something when app is closing
process.on("exit", exitHandler.bind(null, { cleanup: true }));

//catches ctrl+c event
process.on("SIGINT", exitHandler.bind(null, { exit: true }));

// catches "kill pid"
process.on("SIGUSR1", exitHandler.bind(null, { exit: true }));
process.on("SIGUSR2", exitHandler.bind(null, { exit: true }));

//catches uncaught exceptions
process.on("uncaughtException", exitHandler.bind(null, { exit: true }));
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Mon Mar 22 2021 03:20:48 GMT+0100 (Central European Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
